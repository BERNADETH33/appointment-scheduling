<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROTOTECH Scheduler</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght:100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 80px;
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Slightly slower transition */
            position: relative;
            border-radius: 8px; /* Added rounded corners */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow for definition */
        }
        .calendar-day:hover {
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3), 0 2px 4px rgba(66, 153, 225, 0.1); /* Blue glow on hover */
            transform: translateY(-2px); /* Lift slightly more */
            border-color: #63b3ed; /* Light blue border on hover */
        }
        .today {
            border: 3px solid #3b82f6 !important; /* Thicker blue border for today */
            background-color: #dbeafe !important; /* Lighter blue background for today */
            font-weight: 700;
        }
        /* Style for the currently selected day */
        .selected-day {
            background-color: #1e40af !important; /* Dark blue background */
            color: white !important;
            border: 3px solid #1e40af !important;
            box-shadow: 0 6px 15px rgba(30, 64, 175, 0.5);
        }

        .has-appointment::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 7px; /* Slightly larger dot */
            height: 7px;
            background-color: #ef4444; /* Red dot for appointments */
            border-radius: 50%;
            border: 1px solid white; /* Border for visibility on dark backgrounds */
        }
        /* Styling for the daily schedule list items */
        .schedule-item {
            transition: all 0.15s ease-in-out;
        }
        .schedule-item:hover {
            transform: scale(1.01);
        }
        /* Custom styles for form elements */
        .form-input-group {
            border: 1px solid #e0e7ff; /* Light indigo border */
            background-color: #f9faff; /* Very light background */
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .styled-input:focus {
            border-color: #4f46e5 !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); /* Custom focus ring */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    
    <!-- === 1. LANDING VIEW (New Main Page) === -->
    <div id="landing-view" class="max-w-4xl mx-auto mt-20 bg-white shadow-2xl rounded-3xl p-8 md:p-16 text-center border-t-8 border-indigo-600">
        <h1 class="text-7xl font-extrabold text-indigo-900 tracking-tighter mb-4">PROTOTECH</h1>
        <p class="text-3xl text-indigo-600 font-semibold mb-10">Appointment Scheduling System</p>
        
        <p class="text-gray-700 text-lg mb-12 max-w-lg mx-auto">
            Welcome to the centralized hub for all your booking needs. 
            View real-time availability, select your preferred time slot (Online or Face-to-Face), 
            and confirm your appointment instantly.
        </p>

        <button id="start-scheduling-btn" 
            class="bg-indigo-600 text-white py-4 px-10 rounded-lg font-extrabold text-xl uppercase tracking-wider 
                   hover:bg-indigo-700 transition duration-300 shadow-xl hover:shadow-indigo-500/50 transform hover:scale-[1.02] active:scale-95">
            Go to Scheduler
        </button>

        <div id="landing-loading-indicator" class="mt-8 text-blue-500 font-medium hidden">
            Connecting to database...
        </div>
    </div>
    
    <!-- === 2. SCHEDULER VIEW (Existing App Content) === -->
    <div id="scheduler-content" class="max-w-6xl mx-auto bg-white shadow-2xl rounded-xl p-4 md:p-8 hidden">
        
        <!-- === ENHANCED HEADER SECTION WITH TITLE === --><header class="text-center mb-10 pb-6 border-b-2 border-indigo-100">
            <h1 class="text-5xl font-extrabold text-indigo-900 tracking-tight leading-tight">PROTOTECH</h1>
            <p class="text-xl text-indigo-600 mt-2 font-semibold">Appointment Scheduling</p>
        </header>
        <!-- === END ENHANCED HEADER SECTION === --><!-- User Info & Loading State (Always Visible) --><div class="mb-6 text-sm text-center text-gray-500">
            <div id="loading-indicator" class="text-blue-500 font-medium hidden">Initializing application and connecting to database...</div>
            <!-- User ID display removed as requested --></div>

        <!-- Main Content Container for View Switching --><div id="main-content-container">
            
            <!-- 1. CALENDAR VIEW (Default View) --><div id="calendar-view" class="grid grid-cols-1">
                <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                    <!-- Calendar Header --><div class="flex justify-between items-center mb-6">
                        <button id="prev-month-btn" class="p-3 bg-indigo-200 rounded-full text-indigo-800 hover:bg-indigo-300 transition shadow-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <h2 id="month-year-display" class="text-3xl font-extrabold text-indigo-900 tracking-wide"></h2>
                        <button id="next-month-btn" class="p-3 bg-indigo-200 rounded-full text-indigo-800 hover:bg-indigo-300 transition shadow-md">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>

                    <!-- Weekday Headers --><div class="day-grid font-bold text-base text-center text-indigo-700 mb-3">
                        <span>SUN</span><span>MON</span><span>TUE</span><span>WED</span><span>THU</span><span>FRI</span><span>SAT</span>
                    </div>

                    <!-- Calendar Grid --><div id="calendar-grid" class="day-grid">
                        <!-- Days will be rendered here --></div>
                </div>
            </div>

            <!-- 2. DAILY SCHEDULE VIEW (Hidden by Default) --><div id="schedule-view" class="hidden">
                <button id="back-to-calendar-btn" class="mb-6 flex items-center text-indigo-600 hover:text-indigo-800 transition font-semibold text-lg">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Calendar View
                </button>

                <h2 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">
                    Schedule for <span id="schedule-date-title" class="text-indigo-600"></span>
                </h2>

                <div class="grid lg:grid-cols-3 gap-8">
                    
                    <!-- Daily Schedule List (2/3 width) --><div class="lg:col-span-2 bg-indigo-50 p-6 rounded-xl border-2 border-indigo-300 shadow-lg">
                        <h3 class="text-2xl font-bold text-indigo-800 mb-6">Time Slot Availability</h3>
                        <div id="appointments-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-3">
                            <!-- Time slots and status will be rendered here --></div>
                    </div>

                    <!-- Add Appointment Form (1/3 width) --><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl border border-gray-200 h-fit sticky top-4">
                        <h3 class="text-xl font-bold text-indigo-800 mb-5 border-b pb-2">Book an Appointment</h3>
                        <form id="add-appointment-form" class="space-y-5">
                            <!-- Date is shown for confirmation but disabled -->
                            <div class="form-input-group">
                                <label for="appointment-date" class="block text-sm font-bold text-gray-700 mb-1">Date</label>
                                <input type="date" id="appointment-date-display" disabled class="w-full px-3 py-2 bg-indigo-100 border border-indigo-300 rounded-lg text-gray-700 font-medium">
                                <!-- Hidden input to hold the actual selected date --><input type="hidden" id="appointment-date" required> 
                            </div>
                            
                            <!-- Client Name Input -->
                            <div class="form-input-group">
                                <label for="client-name" class="block text-sm font-bold text-gray-700 mb-1">Client Name</label>
                                <input type="text" id="client-name" placeholder="Enter your full name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg styled-input focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 transition duration-150">
                            </div>

                            <!-- Type and Time Slot Group -->
                            <div class="space-y-4">
                                <div class="form-input-group">
                                    <label for="appointment-type" class="block text-sm font-bold text-gray-700 mb-1">Appointment Type</label>
                                    <select id="appointment-type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg styled-input focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 bg-white appearance-none transition duration-150">
                                        <option value="Face-to-Face">Face-to-Face (9 AM - 5 PM)</option>
                                        <option value="Online">Online (9 AM - 9 PM)</option>
                                    </select>
                                </div>

                                <div class="form-input-group">
                                    <label for="appointment-time" class="block text-sm font-bold text-gray-700 mb-1">Time Slot</label>
                                    <select id="appointment-time" required class="w-full px-4 py-2 border border-gray-300 rounded-lg styled-input focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 bg-white appearance-none transition duration-150">
                                        <!-- Time slots will be populated by JavaScript based on type --></select>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-extrabold text-lg uppercase tracking-wider hover:bg-indigo-700 transition duration-300 shadow-xl hover:shadow-indigo-500/50 mt-6">
                                Confirm Booking
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Path
        const APPOINTMENTS_COLLECTION = `artifacts/${appId}/public/data/appointments`;

        // Predefined Time Slots (9 AM - 9 PM, EXCLUDING 12 PM - 1 PM)
        const ALL_TIME_SLOTS = [
            "9:00 AM - 10:00 AM",
            "10:00 AM - 11:00 AM",
            "11:00 AM - 12:00 PM",
            "1:00 PM - 2:00 PM",
            "2:00 PM - 3:00 PM",
            "3:00 PM - 4:00 PM",
            "4:00 PM - 5:00 PM",
            "5:00 PM - 6:00 PM",
            "6:00 PM - 7:00 PM",
            "7:00 PM - 8:00 PM",
            "8:00 PM - 9:00 PM"
        ];

        // === Application State ===
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentView = 'calendar'; // 'calendar' or 'schedule'
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth(); // 0 = Jan, 11 = Dec
        let selectedDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        let appointments = []; // Full list of all appointments from Firestore

        // === DOM Elements ===
        const landingView = document.getElementById('landing-view');
        const schedulerContent = document.getElementById('scheduler-content');
        const startSchedulingBtn = document.getElementById('start-scheduling-btn');
        const landingLoadingIndicator = document.getElementById('landing-loading-indicator');
        
        const calendarView = document.getElementById('calendar-view');
        const scheduleView = document.getElementById('schedule-view');
        const backToCalendarBtn = document.getElementById('back-to-calendar-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        
        const scheduleDateTitle = document.getElementById('schedule-date-title');
        const appointmentsList = document.getElementById('appointments-list');
        const addAppointmentForm = document.getElementById('add-appointment-form');
        const appointmentDateInput = document.getElementById('appointment-date');
        const appointmentDateDisplay = document.getElementById('appointment-date-display');
        const clientNameInput = document.getElementById('client-name'); 
        const appointmentTypeSelect = document.getElementById('appointment-type');
        const appointmentTimeSelect = document.getElementById('appointment-time');
        const loadingIndicator = document.getElementById('loading-indicator'); 

        // Set the default date in the hidden form input and the displayed input
        appointmentDateInput.value = selectedDate;
        appointmentDateDisplay.value = selectedDate;

        // === Date Utility Functions ===
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        function getFirstDayOfMonth(year, month) {
            return new Date(year, month, 1).getDay();
        }
        function formatReadableDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00'); 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }


        // === Slot Management Functions ===

        /**
         * Filters the master time slot list based on the selected appointment type.
         */
        function getAvailableTimeSlots(type) {
            if (type === 'Face-to-Face') {
                // Face-to-Face slots run from 9:00 AM to 5:00 PM. (First 7 slots)
                return ALL_TIME_SLOTS.slice(0, 7); 
            }
            // Online (Full 9 AM to 9 PM schedule, excluding 12-1 PM)
            return ALL_TIME_SLOTS;
        }

        /**
         * Populates the time slot dropdown based on the currently selected appointment type.
         */
        function populateTimeSlots() {
            const selectedType = appointmentTypeSelect.value;
            const slots = getAvailableTimeSlots(selectedType);

            appointmentTimeSelect.innerHTML = '<option value="" disabled selected>Select an available slot</option>';
            slots.forEach(slot => {
                const option = document.createElement('option');
                option.value = slot;
                option.textContent = slot;
                appointmentTimeSelect.appendChild(option);
            });
        }


        // === Firestore Setup and Real-Time Listener ===

        async function initializeFirebase() {
            if (isAuthReady) return; // Already initialized
            
            landingLoadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');

            try {
                // setLogLevel('debug'); // Enable for debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Populate the time slots dropdown immediately with the default (F2F)
                populateTimeSlots();

                // 1. Sign in (using custom token if available, otherwise anonymously)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Auth state listener (ensures userId is set)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // 3. Start real-time listener only after auth is ready
                        startAppointmentsListener();
                    } else {
                        // Signed out or Anonymous user (fallback for userId)
                        userId = crypto.randomUUID(); 
                        isAuthReady = true;
                        startAppointmentsListener();
                    }
                    landingLoadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.add('hidden');
                });
                
                // Add event listener to re-populate slots when type changes
                appointmentTypeSelect.addEventListener('change', populateTimeSlots);

            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                landingLoadingIndicator.textContent = 'Error: Failed to connect to database.';
                loadingIndicator.textContent = 'Error: Failed to connect to database.';
            }
        }

        function startAppointmentsListener() {
            if (!db || !isAuthReady) return;

            const q = query(collection(db, APPOINTMENTS_COLLECTION));
            
            // Real-time listener
            onSnapshot(q, (snapshot) => {
                appointments = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure minimum required fields exist, including the new clientName field.
                    if (data.date && data.time && data.type && data.clientName) { 
                         appointments.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });
                
                // Re-render the current view with new data
                renderView(currentView);
            }, (error) => {
                console.error("Error listening to appointments:", error);
            });
        }

        // === Appointment Functions ===

        /**
         * Adds a new appointment to Firestore.
         */
        async function addAppointment(date, timeSlot, type, clientName) {
            if (!db || !isAuthReady) {
                console.error("Database not ready.");
                return;
            }

            // Check for existing appointment in the same slot
            const isBooked = appointments.some(appt => 
                appt.date === date && appt.time === timeSlot
            );

            if (isBooked) {
                console.warn(`The slot ${timeSlot} on ${date} is already booked.`);
                alertMessage('Slot already booked!', `The time slot ${timeSlot} on ${formatReadableDate(date)} is already taken. Please select another slot.`, 'bg-red-500');
                return;
            }

            try {
                await addDoc(collection(db, APPOINTMENTS_COLLECTION), {
                    date: date, // YYYY-MM-DD
                    time: timeSlot, // Full slot string
                    type: type, // Appointment type
                    clientName: clientName, // NEW
                    userId: userId,
                    createdAt: new Date().toISOString(),
                    // Use clientName in the title for better display in the list
                    title: `${type} Booking by ${clientName}` 
                });
                // Success feedback
                alertMessage('Success!', `Appointment (${type}) booked for ${timeSlot} by ${clientName}.`, 'bg-green-500');
                // The onSnapshot listener will handle the re-render automatically.
            } catch (error) {
                console.error("Error adding document: ", error);
                alertMessage('Error', 'Failed to save appointment.', 'bg-red-500');
            }
        }

        /**
         * Simple custom alert/toast message function (replaces alert())
         */
        function alertMessage(title, message, bgColor) {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'custom-alert';
            alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white ${bgColor} transition-opacity duration-300`;
            alertDiv.innerHTML = `
                <div class="font-bold">${title}</div>
                <div class="text-sm">${message}</div>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }
        
        // Handles form submission
        addAppointmentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = appointmentDateInput.value;
            const clientName = clientNameInput.value.trim(); 
            const timeSlot = appointmentTimeSelect.value;
            const type = appointmentTypeSelect.value;
            
            if (date && timeSlot && type && clientName) {
                await addAppointment(date, timeSlot, type, clientName);
                clientNameInput.value = ''; // Clear input on successful submission
            } else {
                 alertMessage('Warning', 'Please fill all required fields (Name, Date, Type, and Time Slot).', 'bg-yellow-500');
            }
        });


        // === View Switching and Rendering Functions ===
        
        /**
         * Renders the appropriate view based on the current state (calendar or schedule).
         */
        function renderView(viewName) {
            currentView = viewName;
            
            if (viewName === 'calendar') {
                calendarView.classList.remove('hidden');
                scheduleView.classList.add('hidden');
                renderCalendar();
            } else if (viewName === 'schedule') {
                calendarView.classList.add('hidden');
                scheduleView.classList.remove('hidden');
                renderDailyScheduleView();
            }
        }
        
        /**
         * Switches from the landing page to the scheduling interface.
         */
        function showScheduler() {
            landingView.classList.add('hidden');
            schedulerContent.classList.remove('hidden');
            initializeFirebase(); // Initialize Firebase once the user enters the app
            renderView('calendar');
        }

        /**
         * Renders the appointments and availability for the currently selected day.
         */
        function renderDailyScheduleView() {
            scheduleDateTitle.textContent = formatReadableDate(selectedDate);
            // Sync the date in the form for confirmation
            appointmentDateInput.value = selectedDate;
            appointmentDateDisplay.value = selectedDate;
            appointmentsList.innerHTML = '';
            
            const dailyAppointments = appointments.filter(a => a.date === selectedDate);
            
            let bookedCount = 0;

            // Iterate through ALL_TIME_SLOTS (9 AM to 9 PM, excluding 12-1) for the full schedule view
            ALL_TIME_SLOTS.forEach(slot => {
                const bookedAppointment = dailyAppointments.find(a => a.time === slot);
                const item = document.createElement('div');
                item.classList.add('schedule-item', 'rounded-xl', 'p-4', 'shadow-md');

                if (bookedAppointment) {
                    bookedCount++;
                    const typeColor = bookedAppointment.type === 'Online' ? 'bg-indigo-600' : 'bg-red-600';
                    
                    // Retrieve the actual client name
                    const clientName = bookedAppointment.clientName || 'Unknown Client'; 

                    // Slot is booked
                    item.classList.add('bg-red-100', 'border', 'border-red-300');
                    item.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xl font-extrabold text-red-800">${slot}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${typeColor} text-white">${bookedAppointment.type.toUpperCase()} - BOOKED</span>
                        </div>
                        <!-- Shows client name only --><p class="text-sm font-bold text-red-800 mt-1">Booked by: ${clientName}</p>
                    `;
                } else {
                    // Slot is available
                    item.classList.add('bg-green-50', 'border', 'border-green-200');
                    
                    // Determine availability text based on the slot time restrictions
                    let availabilityText;
                    let availabilityClass;

                    const availableTypes = [];
                    if (getAvailableTimeSlots('Face-to-Face').includes(slot)) {
                        availableTypes.push('F2F');
                    }
                    if (getAvailableTimeSlots('Online').includes(slot)) { 
                        availableTypes.push('Online');
                    }

                    if (availableTypes.length === 1 && availableTypes[0] === 'Online') {
                        availabilityText = 'AVAILABLE (Online Only)';
                        availabilityClass = 'bg-yellow-600';
                    } else if (availableTypes.length === 2) {
                         availabilityText = 'AVAILABLE (Online & F2F)';
                         availabilityClass = 'bg-green-600';
                    } else {
                         availabilityText = 'UNAVAILABLE';
                         availabilityClass = 'bg-gray-400';
                    }

                    item.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-extrabold text-green-800">${slot}</span>
                            <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${availabilityClass} text-white">${availabilityText}</span>
                        </div>
                        <p class="text-sm text-green-700 mt-1">Click Schedule Appointment to book this slot.</p>
                    `;
                }
                appointmentsList.appendChild(item);
            });
        }

        /**
         * Renders the main calendar grid.
         */
        function renderCalendar() {
            calendarGrid.innerHTML = '';
            
            const todayDate = formatDate(new Date());
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDayOfWeek = getFirstDayOfMonth(currentYear, currentMonth);
            
            const monthName = new Date(currentYear, currentMonth, 1).toLocaleString('default', { month: 'long' });
            monthYearDisplay.textContent = `${monthName} ${currentYear}`;

            // Create a Set of dates that have appointments in this month for quick lookup
            const datesWithAppointments = new Set(
                appointments
                    .filter(a => {
                        const dateParts = a.date.split('-');
                        return parseInt(dateParts[0]) === currentYear && (parseInt(dateParts[1]) - 1) === currentMonth;
                    })
                    .map(a => a.date)
            );

            // 1. Add blank padding boxes for days before the 1st
            for (let i = 0; i < firstDayOfWeek; i++) {
                const blank = document.createElement('div');
                // Updated styling for blank cells
                blank.className = 'p-2 rounded-lg bg-indigo-100/50'; 
                calendarGrid.appendChild(blank);
            }

            // 2. Add day boxes
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = formatDate(date);

                const dayBox = document.createElement('div');
                // Base classes are now in the style block, but we apply defaults here
                dayBox.classList.add('calendar-day', 'p-2', 'bg-white', 'text-right', 'border');

                // Apply styling classes
                if (dateStr === todayDate) {
                    dayBox.classList.add('today'); 
                } else {
                    dayBox.classList.add('border-gray-200', 'text-gray-900');
                }
                
                // Highlight the selected date in the calendar view
                if (dateStr === selectedDate && currentView === 'calendar') {
                    dayBox.classList.add('selected-day', 'text-white');
                } else {
                    dayBox.classList.add('hover:bg-indigo-50');
                }

                if (datesWithAppointments.has(dateStr)) {
                    dayBox.classList.add('has-appointment', 'font-medium');
                }
                
                dayBox.dataset.date = dateStr;
                dayBox.innerHTML = `<span class="text-lg font-bold">${day}</span>`;
                
                // Click listener: Switch to schedule view
                dayBox.addEventListener('click', (e) => {
                    const clickedDate = e.currentTarget.dataset.date;
                    selectedDate = clickedDate;
                    renderView('schedule');
                });

                calendarGrid.appendChild(dayBox);
            }
        }
        
        // === Event Listeners for Navigation ===
        
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderView('calendar');
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderView('calendar');
        });

        backToCalendarBtn.addEventListener('click', () => {
             renderView('calendar');
        });
        
        // Listener for the new Landing Page button
        startSchedulingBtn.addEventListener('click', showScheduler);


        // === Initialize Application (Starts on Landing Page) ===
        
        // The application starts by displaying the landing view.
        // Firebase initialization is intentionally skipped until showScheduler is called.
        // We only need to render the initial calendar if the user enters the app directly (which doesn't happen with the landing page).

    </script>

</body>
</html>